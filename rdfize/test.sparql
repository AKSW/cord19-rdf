PREFIX covid: <http://covid19.aksw.org/>


# Create resources for the cited documents:
# <thisdocument-citation-[12]>
#   a Citation ; of someWork [ havingAuthors (x y z) ]

INSERT {
  GRAPH ?g { ?s eg:authorJson ?a }
}
WHERE {
  GRAPH ?g { ?s eg:json ?json }
  BIND(json:path(?json, "$.authors") AS ?a)
}



INSERT {
  GRAPH ?g {
    ?s eg:hasCitation ?c .
    ?c eg:authorJson ?a
  }
}
WHERE {
  GRAPH ?g { ?s eg:json ?json }

  BIND(json:path(json:entries(json:path(?json, "$.bib_entries")), "$[*].value") AS ?list)
  ?list json:unnest (?item ?i)
  BIND(json:path(?item, "$.ref_id") AS ?refId)
  BIND(IRI(CONCAT(STR(?s), '-citation-', ?refId)) AS ?c)
  BIND(json:path(?item, "$.authors") AS ?a)

}




CONSTRUCT {
  GRAPH ?g {
    ?s eg:hasAuthor ?a .

    ?a
      a foaf:Person ;
      foaf:firstName ?fn ;
      eg:middleName ?mn ;
      foaf:lastName ?ln ;
      foaf:name ?n ;
      .
}
}
{
  GRAPH ?g { ?s eg:authorJson ?json }

  ?json json:unnest (?item ?i)
  BIND(json:path(?item, "$.first") AS ?fn)
  BIND(json:js("function(x) { return x.middle.join(' '); }", ?item) AS ?mn)
  BIND(json:path(?item, "$.last") AS ?ln)

  BIND(REPLACE(CONCAT(?fn, ' ', ?mn, ' ', ?ln), "\\s+", "") AS ?n)
  #BIND(json:js("function(x, y, z) { return [x, y, z].join(' '); }", ?fn, ?mn, ?ln) AS ?n)
  BIND(IRI(CONCAT(STR(covid:) , ENCODE_FOR_URI(?n))) AS ?a)

#  BIND(SHA256(STR(?text)) AS ?textHash)

#  BIND(IRI(CONCAT(STR(covid:), 'text-', ?textHash)) AS ?a)
}


